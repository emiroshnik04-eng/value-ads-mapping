<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ads Parameter Matcher - Standalone</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .info-banner {
            background: #e3f2fd;
            border: 2px solid #2196F3;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .info-banner strong {
            color: #1565c0;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }

        .filters {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        select, input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        select:disabled, input:disabled {
            background: #f5f5f5;
            cursor: not-allowed;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #45a049;
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #2196F3;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #0b7dda;
        }

        .actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .results {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #f5f5f5;
            font-weight: 600;
            color: #333;
        }

        tr:hover {
            background: #f9f9f9;
        }

        .ad-link {
            color: #2196F3;
            text-decoration: none;
            font-weight: 600;
        }

        .ad-link:hover {
            text-decoration: underline;
        }

        .match-count {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .match-count.single {
            background: #4CAF50;
            color: white;
        }

        .match-count.multiple {
            background: #ff9800;
            color: white;
        }

        .chip {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            border: 1px solid #90caf9;
            display: inline-block;
            margin-right: 4px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="info-banner">
            <strong>ℹ️ STANDALONE MODE:</strong> This tool runs locally using PHP built-in server.
            Start with: <code>cd projects/catalog-microservice/api/web/admin && php -S localhost:8888</code>
        </div>

        <h1>Ads Parameter Matcher</h1>
        <p class="subtitle">Find ads that mention parameter values in title/description but don't have those parameters linked</p>

        <div class="filters">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="country">Country</label>
                    <select id="country">
                        <option value="">Select country...</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="category">Category (Last Level Only)</label>
                    <select id="category" disabled>
                        <option value="">Select category...</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="categorySearch">Or Search by Category ID</label>
                    <input type="number" id="categorySearch" placeholder="Enter category ID..." disabled>
                </div>

                <div class="filter-group">
                    <label for="param">Parameter</label>
                    <select id="param" disabled>
                        <option value="">Select parameter...</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="paramValues">Parameter Values (multiple)</label>
                    <select id="paramValues" multiple disabled style="height: 120px;">
                    </select>
                </div>
            </div>

            <button id="searchBtn" class="btn-primary" onclick="search()" disabled>Search Ads</button>
        </div>

        <div class="actions">
            <div>
                <span id="resultsCount" style="color: #666;">No results yet</span>
            </div>
            <button class="btn-secondary" onclick="exportCSV()" disabled id="exportBtn">Export CSV</button>
        </div>

        <div class="results">
            <div id="loadingMessage" class="loading" style="display: none;">Searching...</div>
            <div id="errorMessage" class="error" style="display: none;"></div>
            <table id="resultsTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Ad ID</th>
                        <th>Title</th>
                        <th>Description</th>
                        <th>Matched Values</th>
                        <th>Match Count</th>
                        <th>Created Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="resultsBody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const API_BASE = window.location.protocol === 'file:'
            ? 'http://localhost:8888'
            : '';

        let currentResults = [];

        // Check if API is available
        async function checkAPI() {
            try {
                const response = await fetch(`${API_BASE}/api-local.php?action=countries`);
                return response.ok;
            } catch (e) {
                return false;
            }
        }

        // Load countries on page load
        window.addEventListener('DOMContentLoaded', async () => {
            loadCountries();
        });

        async function loadCountries() {
            // Hardcoded countries (API endpoint /api/location/v0/countries returns 404)
            const countries = [
                {id: 1, name: 'Kyrgyzstan (KG)', code: 'KG'},
                {id: 2, name: 'Serbia (RS)', code: 'RS'},
                {id: 3, name: 'Poland (PL)', code: 'PL'},
                {id: 4, name: 'Azerbaijan (AZ)', code: 'AZ'}
            ];

            const countrySelect = document.getElementById('country');
            countries.forEach(country => {
                countrySelect.innerHTML += `<option value="${country.id}">${country.name}</option>`;
            });
        }

        // Helper function to extract leaf categories from tree
        function extractLeafCategories(categories, parentPath = '') {
            let leafCategories = [];

            categories.forEach(cat => {
                const currentPath = parentPath ? `${parentPath} > ${cat.name}` : cat.name;

                if (!cat.children || cat.children.length === 0) {
                    // This is a leaf category
                    leafCategories.push({
                        id: cat.id,
                        name: cat.name,
                        path: currentPath
                    });
                } else {
                    // Recursively process children
                    leafCategories = leafCategories.concat(
                        extractLeafCategories(cat.children, currentPath)
                    );
                }
            });

            return leafCategories;
        }

        document.getElementById('country').addEventListener('change', async function() {
            const countryId = this.value;
            const categorySelect = document.getElementById('category');
            const categorySearch = document.getElementById('categorySearch');
            const paramSelect = document.getElementById('param');
            const paramValuesSelect = document.getElementById('paramValues');

            if (!countryId) {
                categorySelect.disabled = true;
                categorySearch.disabled = true;
                paramSelect.disabled = true;
                paramValuesSelect.disabled = true;
                return;
            }

            showLoading(true);

            try {
                // Load category tree from API (internal REST API)
                const apiUrl = `https://api.lalafo.kg/api/catalog/v0/categories/tree/${countryId}`;
                const response = await fetch(`${API_BASE}/api-proxy.php?url=${encodeURIComponent(apiUrl)}`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                // Extract only leaf categories (last level)
                const leafCategories = extractLeafCategories(data);

                // Sort by path for better readability
                leafCategories.sort((a, b) => a.path.localeCompare(b.path));

                categorySelect.innerHTML = '<option value="">Select leaf category...</option>';
                leafCategories.forEach(cat => {
                    categorySelect.innerHTML += `<option value="${cat.id}">[${cat.id}] ${cat.path}</option>`;
                });

                categorySelect.disabled = false;
                categorySearch.disabled = false;
                paramSelect.disabled = true;
                paramValuesSelect.disabled = true;

                console.log(`Loaded ${leafCategories.length} leaf categories`);
            } catch (error) {
                console.error('Failed to load categories:', error);
                showError(`Failed to load categories: ${error.message}. Make sure CORS proxy is working.`);
            } finally {
                showLoading(false);
            }
        });

        // Handle category search by ID
        document.getElementById('categorySearch').addEventListener('input', async function() {
            const countryId = document.getElementById('country').value;
            const categoryId = this.value;
            const categorySelect = document.getElementById('category');

            if (!categoryId) {
                categorySelect.value = '';
                return;
            }

            // Try to find category in the dropdown
            const found = Array.from(categorySelect.options).find(opt => opt.value == categoryId);

            if (found) {
                categorySelect.value = categoryId;
            } else {
                // Not in the list - use the ID anyway
                categorySelect.value = '';
            }

            // Load params for this category
            if (countryId && categoryId) {
                loadParams(countryId, categoryId);
            }
        });

        // Sync category select with search input
        document.getElementById('category').addEventListener('change', async function() {
            document.getElementById('categorySearch').value = this.value;
            const countryId = document.getElementById('country').value;
            const categoryId = this.value;

            if (!categoryId) {
                return;
            }

            loadParams(countryId, categoryId);
        });

        // Function to load parameters for a category
        async function loadParams(countryId, categoryId) {
            const paramSelect = document.getElementById('param');
            const paramValuesSelect = document.getElementById('paramValues');

            if (!countryId || !categoryId) {
                paramSelect.disabled = true;
                paramValuesSelect.disabled = true;
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api-proxy.php?url=${encodeURIComponent(`https://api.lalafo.kg/api/catalog/v0/params/get-all-by-category-and-country-ids?country_id=${countryId}&category_id=${categoryId}`)}`);
                const data = await response.json();

                paramSelect.innerHTML = '<option value="">Select parameter...</option>';
                data.forEach(param => {
                    paramSelect.innerHTML += `<option value="${param.id}">${param.name}</option>`;
                });

                paramSelect.disabled = false;
                paramValuesSelect.disabled = true;

                console.log(`Loaded ${data.length} parameters for category ${categoryId}`);
            } catch (error) {
                console.error('Failed to load params:', error);
                showError('Failed to load parameters');
            }
        }

        document.getElementById('param').addEventListener('change', async function() {
            const countryId = document.getElementById('country').value;
            const categoryId = document.getElementById('category').value;
            const paramId = this.value;
            const paramValuesSelect = document.getElementById('paramValues');
            const searchBtn = document.getElementById('searchBtn');

            if (!paramId) {
                paramValuesSelect.disabled = true;
                searchBtn.disabled = true;
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api-proxy.php?url=${encodeURIComponent(`https://api.lalafo.kg/api/catalog/v0/param_value/get-by-country-category-param?country_id=${countryId}&category_id=${categoryId}&param_id=${paramId}`)}`);
                const data = await response.json();

                paramValuesSelect.innerHTML = '';
                data.forEach(value => {
                    paramValuesSelect.innerHTML += `<option value="${value.id}">${value.alias || value.value}</option>`;
                });

                paramValuesSelect.disabled = false;
                searchBtn.disabled = false;
            } catch (error) {
                console.error('Failed to load param values:', error);
                showError('Failed to load parameter values');
            }
        });

        async function search() {
            const countryId = document.getElementById('country').value;
            const categoryId = document.getElementById('category').value;
            const paramId = document.getElementById('param').value;
            const paramValuesSelect = document.getElementById('paramValues');
            const selectedValues = Array.from(paramValuesSelect.selectedOptions).map(opt => opt.value);

            if (!countryId || !categoryId || !paramId || selectedValues.length === 0) {
                showError('Please select all filters');
                return;
            }

            showLoading(true);
            hideError();

            try {
                const apiUrl = `https://api.lalafo.kg/api/catalog/v0/ad/search-unlinked-params?country_id=${countryId}&category_id=${categoryId}&param_id=${paramId}&param_value_ids=${selectedValues.join(',')}`;

                const response = await fetch(`${API_BASE}/api-proxy.php?url=${encodeURIComponent(apiUrl)}`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                currentResults = data;
                displayResults(data);
            } catch (error) {
                console.error('Search failed:', error);
                showError(`Search failed: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }

        function displayResults(results) {
            const tbody = document.getElementById('resultsBody');
            const table = document.getElementById('resultsTable');
            const resultsCount = document.getElementById('resultsCount');
            const exportBtn = document.getElementById('exportBtn');

            tbody.innerHTML = '';

            if (results.length === 0) {
                resultsCount.textContent = 'No ads found';
                table.style.display = 'none';
                exportBtn.disabled = true;
                return;
            }

            results.forEach(row => {
                const tr = document.createElement('tr');
                const date = new Date(row.created_time * 1000).toLocaleDateString();
                const matchClass = row.match_count > 1 ? 'multiple' : 'single';

                const chips = row.matched_values.split(', ').map(val =>
                    `<span class="chip">${val}</span>`
                ).join('');

                tr.innerHTML = `
                    <td><a href="https://lalafo.kg/ad/${row.ad_id}" target="_blank" class="ad-link">${row.ad_id}</a></td>
                    <td>${row.title}</td>
                    <td>${row.description.substring(0, 100)}...</td>
                    <td>${chips}</td>
                    <td><span class="match-count ${matchClass}">${row.match_count}</span></td>
                    <td>${date}</td>
                    <td><a href="https://lalafo.kg/ad/${row.ad_id}" target="_blank" class="ad-link">View →</a></td>
                `;
                tbody.appendChild(tr);
            });

            resultsCount.textContent = `Found ${results.length} ads`;
            table.style.display = 'table';
            exportBtn.disabled = false;
        }

        function exportCSV() {
            if (currentResults.length === 0) return;

            const csvContent = [
                ['Ad ID', 'Title', 'Description', 'Matched Values', 'Match Count', 'Created Date', 'URL'],
                ...currentResults.map(row => [
                    row.ad_id,
                    `"${row.title.replace(/"/g, '""')}"`,
                    `"${row.description.replace(/"/g, '""')}"`,
                    `"${row.matched_values}"`,
                    row.match_count,
                    new Date(row.created_time * 1000).toLocaleDateString(),
                    `https://lalafo.kg/ad/${row.ad_id}`
                ])
            ].map(row => row.join(',')).join('\n');

            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ads-param-matcher-${Date.now()}.csv`;
            link.click();
        }

        function showLoading(show) {
            document.getElementById('loadingMessage').style.display = show ? 'block' : 'none';
            document.getElementById('resultsTable').style.display = show ? 'none' : 'table';
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }
    </script>
</body>
</html>
