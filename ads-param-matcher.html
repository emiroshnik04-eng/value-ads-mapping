<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ads Parameter Matcher - Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }

        .filters {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        select, input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        select:disabled, input:disabled {
            background: #f5f5f5;
            cursor: not-allowed;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #45a049;
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #2196F3;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #0b7dda;
        }

        .btn-secondary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .results {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #f5f5f5;
            font-weight: 600;
            color: #333;
        }

        tr:hover {
            background: #f9f9f9;
        }

        .ad-link {
            color: #2196F3;
            text-decoration: none;
            font-weight: 600;
        }

        .ad-link:hover {
            text-decoration: underline;
        }

        .match-count {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .match-count.single {
            background: #4CAF50;
            color: white;
        }

        .match-count.multiple {
            background: #ff9800;
            color: white;
        }

        .matched-values {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .chip {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            border: 1px solid #90caf9;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2196F3;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #c62828;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Ads Parameter Matcher</h1>
        <p class="subtitle">Find ads that mention parameter values in title/description but don't have those parameters linked</p>

        <div class="filters">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="country">Country</label>
                    <select id="country">
                        <option value="">Select country...</option>
                        <option value="11">Serbia (RS)</option>
                        <option value="12">Kyrgyzstan (KG)</option>
                        <option value="13">Azerbaijan (AZ)</option>
                        <option value="14">Poland (PL)</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="category">Category</label>
                    <input type="text" id="categorySearch" placeholder="Type to search by name or ID..." disabled
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; margin-bottom: 5px;">
                    <select id="category" disabled>
                        <option value="">Select category...</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="param">Parameter</label>
                    <select id="param" disabled>
                        <option value="">Select parameter...</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="paramValues">Parameter Values (multiple)</label>
                    <select id="paramValues" multiple disabled style="height: 120px;">
                    </select>
                </div>
            </div>

            <button id="searchBtn" class="btn-primary" disabled>Search Ads</button>
        </div>

        <div id="errorContainer"></div>

        <div class="actions">
            <div>
                <span id="resultsCount" style="color: #666;"></span>
            </div>
            <button id="exportBtn" class="btn-secondary" disabled>Export CSV</button>
        </div>

        <div class="results">
            <div id="loadingState" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p style="margin-top: 20px;">Searching...</p>
            </div>
            <div id="emptyState" class="empty-state">
                <p>Select filters and click "Search Ads" to find matching ads</p>
            </div>
            <table id="resultsTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Ad ID</th>
                        <th>Title</th>
                        <th>Description</th>
                        <th>Matched Values</th>
                        <th>Match Count</th>
                        <th>Created Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="resultsBody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let currentResults = [];
        let allCategories = [];

        // Elements
        const countrySelect = document.getElementById('country');
        const categorySearch = document.getElementById('categorySearch');
        const categorySelect = document.getElementById('category');
        const paramSelect = document.getElementById('param');
        const paramValuesSelect = document.getElementById('paramValues');
        const searchBtn = document.getElementById('searchBtn');
        const exportBtn = document.getElementById('exportBtn');
        const resultsTable = document.getElementById('resultsTable');
        const resultsBody = document.getElementById('resultsBody');
        const emptyState = document.getElementById('emptyState');
        const loadingState = document.getElementById('loadingState');
        const resultsCount = document.getElementById('resultsCount');
        const errorContainer = document.getElementById('errorContainer');

        // Show error
        function showError(message) {
            errorContainer.innerHTML = `<div class="error">${message}</div>`;
            setTimeout(() => {
                errorContainer.innerHTML = '';
            }, 5000);
        }

        // Filter and display categories
        function filterCategories(searchTerm = '') {
            console.log('filterCategories called with:', searchTerm);
            console.log('allCategories length:', allCategories.length);

            if (allCategories.length === 0) {
                categorySelect.innerHTML = '<option value="">No categories loaded</option>';
                return;
            }

            let filtered = allCategories;

            if (searchTerm.trim()) {
                const term = searchTerm.toLowerCase().trim();
                console.log('Filtering by term:', term);
                filtered = allCategories.filter(cat =>
                    cat.name.toLowerCase().includes(term) ||
                    cat.id.toString().includes(term)
                );
                console.log('Filtered results:', filtered.length);
            }

            // Limit to 500 for performance
            const limited = filtered.slice(0, 500);

            const options = ['<option value="">Select category...</option>'];
            limited.forEach(cat => {
                const displayName = cat.name_translated || cat.name;
                options.push(`<option value="${cat.id}">${displayName} (${cat.id})</option>`);
            });

            if (filtered.length > 500) {
                options.push(`<option disabled>-- Showing first 500 of ${filtered.length} results --</option>`);
            }

            categorySelect.innerHTML = options.join('');

            if (filtered.length === 0) {
                categorySelect.innerHTML = '<option value="">No categories found</option>';
            }
        }

        // Category search handler
        categorySearch.addEventListener('input', (e) => {
            filterCategories(e.target.value);
        });

        // Fetch categories
        countrySelect.addEventListener('change', async () => {
            const countryId = countrySelect.value;

            if (!countryId) {
                allCategories = [];
                categorySearch.disabled = true;
                categorySearch.value = '';
                categorySelect.disabled = true;
                categorySelect.innerHTML = '<option value="">Select category...</option>';
                paramSelect.disabled = true;
                paramSelect.innerHTML = '<option value="">Select parameter...</option>';
                paramValuesSelect.disabled = true;
                paramValuesSelect.innerHTML = '';
                searchBtn.disabled = true;
                return;
            }

            try {
                console.log('Loading categories for country:', countryId);
                categorySelect.innerHTML = '<option value="">Loading...</option>';
                categorySelect.disabled = true;
                categorySearch.disabled = true;
                categorySearch.value = '';

                const response = await fetch(`${API_BASE}/get-categories.php?country_id=${countryId}`);
                console.log('Response status:', response.status);

                const result = await response.json();
                console.log('Result:', result.success, 'Categories count:', result.data?.length);

                if (!result.success) {
                    throw new Error(result.error || 'Failed to load categories');
                }

                allCategories = result.data;

                // Display categories using filter function
                filterCategories();

                console.log('Categories loaded successfully');
                categorySelect.disabled = false;
                categorySearch.disabled = false;
                paramSelect.disabled = true;
                paramSelect.innerHTML = '<option value="">Select parameter...</option>';
                paramValuesSelect.disabled = true;
                paramValuesSelect.innerHTML = '';
                searchBtn.disabled = true;
            } catch (error) {
                console.error('Error loading categories:', error);
                categorySelect.innerHTML = '<option value="">Error loading categories</option>';
                categorySearch.disabled = true;
                showError('Failed to load categories: ' + error.message);
            }
        });

        // Fetch params
        categorySelect.addEventListener('change', async () => {
            const countryId = countrySelect.value;
            const categoryId = categorySelect.value;

            if (!categoryId) {
                paramSelect.disabled = true;
                paramSelect.innerHTML = '<option value="">Select parameter...</option>';
                paramValuesSelect.disabled = true;
                paramValuesSelect.innerHTML = '';
                searchBtn.disabled = true;
                return;
            }

            try {
                console.log('Loading params for category:', categoryId);
                const response = await fetch(`${API_BASE}/get-params.php?country_id=${countryId}&category_id=${categoryId}`);
                const data = await response.json();
                console.log('Params loaded:', data.length);

                const options = ['<option value="">Select parameter...</option>'];
                data.forEach(param => {
                    const displayName = param.name_translated || param.name;
                    options.push(`<option value="${param.id}">${displayName} (${param.id})</option>`);
                });
                paramSelect.innerHTML = options.join('');

                paramSelect.disabled = false;
                paramValuesSelect.disabled = true;
                paramValuesSelect.innerHTML = '';
                searchBtn.disabled = true;
            } catch (error) {
                console.error('Error loading params:', error);
                showError('Failed to load parameters: ' + error.message);
            }
        });

        // Fetch param values
        paramSelect.addEventListener('change', async () => {
            const countryId = countrySelect.value;
            const categoryId = categorySelect.value;
            const paramId = paramSelect.value;

            if (!paramId) {
                paramValuesSelect.disabled = true;
                searchBtn.disabled = true;
                return;
            }

            try {
                console.log('Loading param values for param:', paramId);
                const response = await fetch(`${API_BASE}/get-param-values.php?country_id=${countryId}&category_id=${categoryId}&param_id=${paramId}`);
                const data = await response.json();
                console.log('Param values response:', data);

                // Check if response is an error
                if (data.error) {
                    throw new Error(data.error + (data.message ? ': ' + data.message : ''));
                }

                // Check if response is an array
                if (!Array.isArray(data)) {
                    throw new Error('Invalid response format - expected array, got: ' + typeof data);
                }

                console.log('Param values loaded:', data.length);

                const options = [];
                data.forEach(value => {
                    const displayValue = value.display_value_translated || value.display_value || value.value;
                    options.push(`<option value="${value.id}">${displayValue} (${value.id})</option>`);
                });
                paramValuesSelect.innerHTML = options.join('');

                if (data.length === 0) {
                    paramValuesSelect.innerHTML = '<option value="">No values found</option>';
                }

                paramValuesSelect.disabled = false;
            } catch (error) {
                console.error('Error loading param values:', error);
                paramValuesSelect.innerHTML = '<option value="">Error loading values</option>';
                showError('Failed to load parameter values: ' + error.message);
            }
        });

        // Enable search button when param values selected
        paramValuesSelect.addEventListener('change', () => {
            const selectedOptions = Array.from(paramValuesSelect.selectedOptions);
            searchBtn.disabled = selectedOptions.length === 0;
        });

        // Search ads
        searchBtn.addEventListener('click', async () => {
            const countryId = countrySelect.value;
            const categoryId = categorySelect.value;
            const paramId = paramSelect.value;
            const paramValueIds = Array.from(paramValuesSelect.selectedOptions).map(opt => opt.value).join(',');

            if (!paramValueIds) return;

            emptyState.style.display = 'none';
            resultsTable.style.display = 'none';
            loadingState.style.display = 'block';

            try {
                const response = await fetch(
                    `${API_BASE}/search-unlinked-ads.php?country_id=${countryId}&category_id=${categoryId}&param_id=${paramId}&param_value_ids=${paramValueIds}`
                );

                if (!response.ok) {
                    throw new Error('Search failed: ' + response.statusText);
                }

                const data = await response.json();
                currentResults = data.results || [];

                loadingState.style.display = 'none';

                if (currentResults.length === 0) {
                    emptyState.innerHTML = '<p>No matching ads found</p>';
                    emptyState.style.display = 'block';
                    exportBtn.disabled = true;
                    resultsCount.textContent = '';
                    return;
                }

                displayResults(currentResults);
                resultsCount.textContent = `Found ${currentResults.length} ads`;
                exportBtn.disabled = false;

            } catch (error) {
                loadingState.style.display = 'none';
                emptyState.innerHTML = '<p>Error searching ads. Please try again.</p>';
                emptyState.style.display = 'block';
                showError('Search failed: ' + error.message);
            }
        });

        // Display results
        function displayResults(results) {
            resultsBody.innerHTML = '';

            results.forEach(ad => {
                const row = document.createElement('tr');

                const matchedValues = ad.matched_values ? ad.matched_values.split(', ') : [];
                const matchedChips = matchedValues.map(val => `<span class="chip">${val}</span>`).join('');

                const matchClass = ad.match_count > 1 ? 'multiple' : 'single';
                const createdDate = new Date(ad.created_time * 1000).toLocaleDateString('en-GB');

                row.innerHTML = `
                    <td><a href="https://lalafo.kg/ad/${ad.ad_id}" target="_blank" class="ad-link">${ad.ad_id}</a></td>
                    <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${ad.title}">${ad.title}</td>
                    <td style="max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${ad.description}">${ad.description}</td>
                    <td><div class="matched-values">${matchedChips}</div></td>
                    <td><span class="match-count ${matchClass}">${ad.match_count}</span></td>
                    <td>${createdDate}</td>
                    <td><a href="https://lalafo.kg/ad/${ad.ad_id}" target="_blank" class="ad-link">View â†’</a></td>
                `;

                resultsBody.appendChild(row);
            });

            resultsTable.style.display = 'table';
        }

        // Export CSV
        exportBtn.addEventListener('click', () => {
            if (currentResults.length === 0) return;

            const csvRows = [
                ['Ad ID', 'Title', 'Description', 'Matched Values', 'Match Count', 'Created Date', 'URL']
            ];

            currentResults.forEach(ad => {
                csvRows.push([
                    ad.ad_id,
                    `"${(ad.title || '').replace(/"/g, '""')}"`,
                    `"${(ad.description || '').replace(/"/g, '""')}"`,
                    `"${ad.matched_values || ''}"`,
                    ad.match_count,
                    new Date(ad.created_time * 1000).toLocaleDateString('en-GB'),
                    `https://lalafo.kg/ad/${ad.ad_id}`
                ]);
            });

            const csvContent = csvRows.map(row => row.join(',')).join('\n');
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', `ads-param-matcher-${Date.now()}.csv`);
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    </script>
</body>
</html>
